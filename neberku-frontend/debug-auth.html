<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Authentication - Neberku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>üîç Authentication Debug</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Current State</h5>
                    </div>
                    <div class="card-body">
                        <div id="currentState">
                            <p><strong>User Data:</strong> <span id="userData">Loading...</span></p>
                            <p><strong>Cookies:</strong> <span id="cookies">Loading...</span></p>
                            <p><strong>Session ID:</strong> <span id="sessionId">Loading...</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testDebugAuth()">Test Debug Auth</button>
                        <button class="btn btn-success mb-2" onclick="testLogin()">Test Login</button>
                        <button class="btn btn-info mb-2" onclick="testEvents()">Test Events API</button>
                        <button class="btn btn-warning mb-2" onclick="clearData()">Clear Data</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Debug Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugLog" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // Debug logging function
        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Update current state display
        function updateState() {
            const userData = localStorage.getItem('neberku_user');
            const cookies = document.cookie;
            
            document.getElementById('userData').textContent = userData ? JSON.stringify(JSON.parse(userData)) : 'None';
            document.getElementById('cookies').textContent = cookies || 'None';
            document.getElementById('sessionId').textContent = 'Will be shown after API call';
        }

        // Test debug authentication endpoint
        async function testDebugAuth() {
            try {
                log('üîç Testing debug auth endpoint...');
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/debug-auth/`, {
                    method: 'GET',
                    credentials: 'include',
                    mode: 'cors'
                });
                
                log(`üì° Response status: ${response.status}`);
                log(`üì° Response headers: ${JSON.stringify([...response.headers.entries()])}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Debug auth response: ${JSON.stringify(data, null, 2)}`);
                    
                    // Update session ID display
                    document.getElementById('sessionId').textContent = data.session_id || 'None';
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Error: ${errorText}`);
                }
            } catch (error) {
                log(`‚ùå Exception: ${error.message}`);
            }
        }

        // Test login
        async function testLogin() {
            try {
                log('üîê Testing login...');
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    }),
                    credentials: 'include',
                    mode: 'cors'
                });
                
                log(`üì° Login response status: ${response.status}`);
                log(`üì° Login response headers: ${JSON.stringify([...response.headers.entries()])}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Login successful: ${JSON.stringify(data, null, 2)}`);
                    
                    // Store user data
                    if (data.user) {
                        localStorage.setItem('neberku_user', JSON.stringify(data.user));
                        updateState();
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Login failed: ${errorText}`);
                }
            } catch (error) {
                log(`‚ùå Login exception: ${error.message}`);
            }
        }

        // Test events API
        async function testEvents() {
            try {
                log('üìä Testing events API...');
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/events/`, {
                    method: 'GET',
                    credentials: 'include',
                    mode: 'cors'
                });
                
                log(`üì° Events response status: ${response.status}`);
                log(`üì° Events response headers: ${JSON.stringify([...response.headers.entries()])}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Events API successful: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Events API failed: ${errorText}`);
                }
            } catch (error) {
                log(`‚ùå Events API exception: ${error.message}`);
            }
        }

        // Clear stored data
        function clearData() {
            localStorage.removeItem('neberku_user');
            log('üóëÔ∏è Cleared stored user data');
            updateState();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Debug page loaded');
            updateState();
        });
    </script>
</body>
</html> 