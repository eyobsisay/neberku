<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test File Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Test File Upload Functionality</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>File Upload Test</h5>
                    </div>
                    <div class="card-body">
                        <form id="testForm">
                            <div class="mb-3">
                                <label for="mediaFiles" class="form-label">
                                    <i class="fas fa-images me-1"></i>Select Files
                                </label>
                                <input type="file" class="form-control" id="mediaFiles" 
                                       multiple accept="image/*,video/*">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Multiple Upload Support:</strong><br>
                                    • Select multiple files by holding Ctrl (or Cmd on Mac) and clicking<br>
                                    • Drag & drop multiple files at once<br>
                                    • <strong>Max 3 files per contribution</strong><br>
                                    • <strong>Max 10MB per file</strong><br>
                                    • Supported: Images (JPG, PNG, GIF) & Videos (MP4, MOV, AVI)
                                </div>
                            </div>
                            
                            <div id="fileList">
                                <!-- Selected files will be displayed here -->
                            </div>
                            
                            <div id="modalErrorContainer" class="mt-3" style="display: none;">
                                <!-- Errors will be displayed here -->
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Debug Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugInfo">
                            <p>No files selected yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TestFileManager {
            constructor() {
                this.currentEvent = {
                    guest_max_media_per_post: 3
                };
                this.init();
            }

            init() {
                this.bindEvents();
            }

            bindEvents() {
                // File input change
                const mediaFilesInput = document.getElementById('mediaFiles');
                if (mediaFilesInput) {
                    mediaFilesInput.addEventListener('change', (e) => {
                        console.log('File input change event triggered');
                        console.log('New files:', e.target.files);
                        
                        // Get the new files that were just selected
                        const newFiles = e.target.files;
                        
                        if (newFiles.length === 0) return;
                        
                        // Check if adding these files would exceed the limit
                        const currentCount = this.getCurrentFileCount();
                        const maxCount = this.currentEvent?.guest_max_media_per_post || 3;
                        
                        console.log(`Current count: ${currentCount}, New files: ${newFiles.length}, Max: ${maxCount}`);
                        
                        if (currentCount + newFiles.length > maxCount) {
                            this.showAlert(`Cannot add ${newFiles.length} files. You currently have ${currentCount} files and maximum ${maxCount} files allowed.`, 'warning');
                            // Reset the file input to prevent exceeding limits
                            e.target.value = '';
                            return;
                        }
                        
                        // Process the new files
                        this.handleFileSelection(newFiles);
                    });
                    
                    // Add drag and drop support
                    this.setupDragAndDrop(mediaFilesInput);
                }
            }

            handleFileSelection(newFiles) {
                console.log('handleFileSelection called with:', newFiles);
                
                const fileList = document.getElementById('fileList');
                if (!fileList) return;

                // Get current files from the file input
                const fileInput = document.getElementById('mediaFiles');
                if (!fileInput) return;
                
                // Get all current files (existing + new)
                const allFiles = Array.from(fileInput.files);
                console.log('All files in input:', allFiles);
                
                // Clear the file list display
                fileList.innerHTML = '';
                
                let photoCount = 0;
                let videoCount = 0;
                
                // Display all files with proper indexing
                allFiles.forEach((file, index) => {
                    console.log(`Processing file ${index}:`, file.name, file.type, file.size);
                    
                    const fileItem = document.createElement('div');
                    const isImage = file.type.startsWith('image/');
                    const isVideo = file.type.startsWith('video/');
                    
                    // Determine icon and color based on file type
                    let icon = 'fas fa-file';
                    let alertClass = 'alert-info';
                    
                    if (isImage) {
                        icon = 'fas fa-image';
                        alertClass = 'alert-success';
                        photoCount++;
                    } else if (isVideo) {
                        icon = 'fas fa-video';
                        alertClass = 'alert-warning';
                        videoCount++;
                    }
                    
                    fileItem.className = `alert ${alertClass} d-flex justify-content-between align-items-center`;
                    fileItem.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="${icon} me-2"></i>
                            <span>${file.name}</span>
                            <small class="text-muted ms-2">(${this.formatFileSize(file.size)})</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="testManager.removeFile(${index}, this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });
                
                // Show summary
                if (allFiles.length > 0) {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'alert alert-primary mt-2';
                    summaryDiv.innerHTML = `
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Selected Files:</strong> ${allFiles.length} total 
                        ${photoCount > 0 ? `(${photoCount} photos` : ''}${photoCount > 0 && videoCount > 0 ? ', ' : ''}${photoCount > 0 ? `${photoCount} photos` : ''}${photoCount > 0 && videoCount > 0 ? ', ' : ''}${videoCount > 0 ? `${videoCount} videos` : ''}${photoCount > 0 || videoCount > 0 ? ')' : ''}
                    `;
                    fileList.appendChild(summaryDiv);
                    
                    // Show remaining file count
                    const maxCount = this.currentEvent?.guest_max_media_per_post || 3;
                    const remainingCount = maxCount - allFiles.length;
                    if (remainingCount > 0) {
                        const remainingDiv = document.createElement('div');
                        remainingDiv.className = 'alert alert-success mt-2';
                        remainingDiv.innerHTML = `
                            <i class="fas fa-plus-circle me-2"></i>
                            <strong>You can add ${remainingCount} more file${remainingCount !== 1 ? 's' : ''}</strong>
                        `;
                        fileList.appendChild(remainingDiv);
                    } else {
                        const limitReachedDiv = document.createElement('div');
                        limitReachedDiv.className = 'alert alert-warning mt-2';
                        limitReachedDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Maximum file limit reached (${maxCount} files)</strong>
                        `;
                        fileList.appendChild(limitReachedDiv);
                    }
                }
                
                // Update debug info
                this.updateDebugInfo(allFiles);
            }

            removeFile(fileIndex, buttonElement) {
                console.log('removeFile called with index:', fileIndex);
                
                const fileInput = document.getElementById('mediaFiles');
                if (!fileInput) return;

                // Get current files
                const currentFiles = Array.from(fileInput.files);
                console.log('Current files before removal:', currentFiles.map(f => f.name));
                
                // Remove the file at the specified index
                currentFiles.splice(fileIndex, 1);
                console.log('Files after removal:', currentFiles.map(f => f.name));
                
                // Create a new FileList-like object
                const dataTransfer = new DataTransfer();
                currentFiles.forEach(file => dataTransfer.items.add(file));
                
                // Update the file input
                fileInput.files = dataTransfer.files;
                
                // Refresh the entire file list display to update counts and summary
                this.handleFileSelection([]);
                
                // Show success message
                this.showAlert('File removed successfully', 'success');
            }

            getCurrentFileCount() {
                const fileInput = document.getElementById('mediaFiles');
                return fileInput ? fileInput.files.length : 0;
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            showAlert(message, type = 'info') {
                const alertContainer = document.getElementById('modalErrorContainer');
                if (!alertContainer) return;

                alertContainer.style.display = 'block';

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                alertContainer.appendChild(alertDiv);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                        // Hide container if no more errors
                        if (alertContainer.children.length === 0) {
                            alertContainer.style.display = 'none';
                        }
                    }
                }, 5000);
            }

            updateDebugInfo(files) {
                const debugInfo = document.getElementById('debugInfo');
                if (!debugInfo) return;
                
                debugInfo.innerHTML = `
                    <h6>File Input State:</h6>
                    <ul>
                        <li>Files in input: ${files.length}</li>
                        <li>File names: ${files.map(f => f.name).join(', ') || 'None'}</li>
                        <li>File types: ${files.map(f => f.type).join(', ') || 'None'}</li>
                        <li>File sizes: ${files.map(f => this.formatFileSize(f.size)).join(', ') || 'None'}</li>
                    </ul>
                    <h6>Current Event:</h6>
                    <ul>
                        <li>Max media per post: ${this.currentEvent?.guest_max_media_per_post || 3}</li>
                    </ul>
                `;
            }

            setupDragAndDrop(fileInput) {
                const container = fileInput.parentElement;
                
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    container.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                // Highlight drop area when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    container.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    container.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight(e) {
                    container.classList.add('drag-over');
                }
                
                function unhighlight(e) {
                    container.classList.remove('drag-over');
                }
                
                // Handle dropped files
                container.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        // Get current files and add new ones
                        const currentFiles = Array.from(fileInput.files);
                        const newFiles = Array.from(files);
                        
                        // Check if adding new files would exceed the limit
                        const guestMaxMedia = window.testManager?.currentEvent?.guest_max_media_per_post || 3;
                        if (currentFiles.length + newFiles.length > guestMaxMedia) {
                            if (window.testManager) {
                                window.testManager.showAlert(`Cannot add ${newFiles.length} files. You currently have ${currentFiles.length} files and maximum ${guestMaxMedia} files allowed.`, 'warning');
                            }
                            return;
                        }
                        
                        // Combine current and new files
                        const allFiles = [...currentFiles, ...newFiles];
                        
                        // Update the file input with combined files
                        const dataTransfer = new DataTransfer();
                        allFiles.forEach(file => dataTransfer.items.add(file));
                        fileInput.files = dataTransfer.files;
                        
                        // Process the files to update the display
                        if (window.testManager) {
                            window.testManager.handleFileSelection([]);
                        }
                        
                        // Show success message
                        if (window.testManager) {
                            window.testManager.showAlert(`Successfully added ${newFiles.length} file(s)`, 'success');
                        }
                    }
                }
            }
        }

        // Initialize the test manager when the page loads
        let testManager;
        document.addEventListener('DOMContentLoaded', function() {
            testManager = new TestFileManager();
            window.testManager = testManager;
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
