{% extends 'core/base.html' %}

{% block title %}Guest Contribution - Neberku{% endblock %}

{% block navigation %}
<li class="nav-item">
    <a class="nav-link" href="#event-info">Event Info</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#contribute">Contribute</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#gallery">Gallery</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#share">Share</a>
</li>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold" id="eventTitle">Event Title</h1>
                <p class="lead" id="eventDescription">Event description will be loaded here</p>
                <div class="d-flex gap-3">
                    <button class="btn btn-light btn-lg" onclick="scrollToContribute()">
                        <i class="bi bi-camera"></i> Share Your Memories
                    </button>
                    <button class="btn btn-outline-light btn-lg" onclick="scrollToGallery()">
                        <i class="bi bi-images"></i> View Gallery
                    </button>
                </div>
            </div>
            <div class="col-lg-4 text-center">
                <div id="eventThumbnailContainer">
                    <i class="bi bi-calendar-event" style="font-size: 8rem; opacity: 0.8;"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Event Information -->
<section id="event-info" class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h2 class="mb-4">About This Event</h2>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-calendar-date text-primary" style="font-size: 2rem;"></i>
                                <h5 class="card-title mt-3">Event Date</h5>
                                <p class="card-text" id="eventDate">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-geo-alt text-success" style="font-size: 2rem;"></i>
                                <h5 class="card-title mt-3">Location</h5>
                                <p class="card-text" id="eventLocation">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <h5>Event Features</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-image text-info me-2"></i>
                                <span id="photosAllowed">Photos allowed</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-camera-video text-warning me-2"></i>
                                <span id="videosAllowed">Videos allowed</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-chat-heart text-danger me-2"></i>
                                <span id="wishesAllowed">Wishes allowed</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Event Statistics</h5>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h4 class="text-primary" id="guestPostsCount">0</h4>
                                    <small class="text-muted">Contributions</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success" id="mediaFilesCount">0</h4>
                                <small class="text-muted">Media Files</small>
                            </div>
                        </div>
                        
                        <!-- QR Code Section -->
                        <div class="mt-4" id="qrCodeSection" style="display: none;">
                            <h6>Scan to Share</h6>
                            <div class="qr-code-container text-center">
                                <img id="eventQRCode" src="" alt="Event QR Code" class="img-fluid" style="max-width: 150px;">
                            </div>
                            <small class="text-muted d-block mt-2">Scan this QR code to share the event</small>
                        </div>
                        
                        <!-- Like Section -->
                        <div class="mt-3">
                            <button class="btn btn-outline-danger btn-sm" id="likeButton" onclick="toggleLike()">
                                <i class="bi bi-heart" id="likeIcon"></i>
                                <span id="likeCount">0</span> Likes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Contribution Form -->
<section id="contribute" class="py-5 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">
                            <i class="bi bi-camera"></i> Share Your Memories
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="contributionForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="guestName" class="form-label">Your Name *</label>
                                    <input type="text" class="form-control" id="guestName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="guestPhone" class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-control" id="guestPhone" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="wishText" class="form-label">Your Message/Wish</label>
                                <textarea class="form-control" id="wishText" rows="4" 
                                    placeholder="Share your thoughts, wishes, or memories from the event..."></textarea>
                            </div>
                            
                            <!-- Photo Upload -->
                            <div class="mb-3" id="photoUploadSection">
                                <label class="form-label">Photos</label>
                                <div class="upload-area" id="photoUploadArea">
                                    <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                    <p class="mt-2 mb-0">Drag & drop photos here or click to browse</p>
                                    <small class="text-muted">Supported formats: JPG, PNG, GIF, WebP</small>
                                    <input type="file" id="photoInput" multiple accept="image/*" style="display: none;">
                                </div>
                                <div id="photoPreviewContainer" class="mt-3"></div>
                            </div>
                            
                            <!-- Video Upload -->
                            <div class="mb-3" id="videoUploadSection">
                                <label class="form-label">Videos</label>
                                <div class="upload-area" id="videoUploadArea">
                                    <i class="bi bi-camera-video text-muted" style="font-size: 2rem;"></i>
                                    <p class="mt-2 mb-0">Drag & drop videos here or click to browse</p>
                                    <small class="text-muted">Supported formats: MP4, AVI, MOV, WebM</small>
                                    <input type="file" id="videoInput" multiple accept="video/*" style="display: none;">
                                </div>
                                <div id="videoPreviewContainer" class="mt-3"></div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="bi bi-send"></i> Submit Contribution
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Gallery Section -->
<section id="gallery" class="py-5">
    <div class="container">
        <h2 class="text-center mb-5">Event Gallery</h2>
        <div class="row g-4" id="galleryContainer">
            <!-- Gallery items will be loaded here -->
        </div>
        <div class="text-center mt-4">
            <button class="btn btn-outline-primary" onclick="loadMoreGalleryItems()" id="loadMoreBtn" style="display: none;">
                Load More
            </button>
        </div>
    </div>
</section>

<!-- Share Section -->
<section id="share" class="py-5 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <h3>Share This Event</h3>
                <p class="lead">Invite others to contribute their memories!</p>
                
                <!-- QR Code for Mobile Sharing -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">QR Code</h5>
                                <p class="text-muted">Scan with your phone to share</p>
                                <div id="shareQRCode" class="text-center">
                                    <i class="bi bi-qr-code" style="font-size: 4rem; opacity: 0.5;"></i>
                                    <p class="text-muted mt-2">QR Code will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Share Link</h5>
                                <p class="text-muted">Copy and share this link</p>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="shareLinkInput" readonly>
                                    <button class="btn btn-outline-primary" type="button" onclick="copyShareLink()">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-primary" onclick="shareEvent()">
                        <i class="bi bi-share"></i> Share Event
                    </button>
                    <button class="btn btn-outline-primary" onclick="copyEventLink()">
                        <i class="bi bi-link-45deg"></i> Copy Link
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i> Contribution Submitted!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Thank you for sharing your memories! Your contribution has been submitted successfully.</p>
                <p class="mb-0"><strong>Note:</strong> Your photos and videos will be reviewed by the event host before appearing in the gallery.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">Great!</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Error
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage">An error occurred while submitting your contribution.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let eventData = null;
let currentGalleryPage = 1;
let galleryItems = [];
let selectedPhotos = [];
let selectedVideos = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadEventData();
    setupFileUploads();
    setupFormValidation();
});

// Load event data from URL parameters
async function loadEventData() {
    // Get event ID from Django context variable
    const eventId = '{{ event_id }}';
    
    console.log('Event ID from context:', eventId);
    console.log('Current URL:', window.location.href);
    
    if (!eventId) {
        showError('No event ID provided');
        return;
    }
    
    try {
        const response = await fetch(`/api/public-events/${eventId}/`);
        console.log('API Response status:', response.status);
        
        if (response.ok) {
            eventData = await response.json();
            console.log('Event data loaded:', eventData);
            displayEventInfo();
            loadGallery();
        } else {
            const errorData = await response.json();
            console.error('API Error:', errorData);
            showError('Event not found or not accessible');
        }
    } catch (error) {
        console.error('Error loading event data:', error);
        showError('Error loading event data');
    }
}

// Display event information
function displayEventInfo() {
    if (!eventData) {
        console.error('No event data available');
        return;
    }
    
    console.log('Displaying event info:', eventData);
    
    document.getElementById('eventTitle').textContent = eventData.title;
    document.getElementById('eventDescription').textContent = eventData.description || 'No description available';
    document.getElementById('eventDate').textContent = new Date(eventData.event_date).toLocaleDateString();
    document.getElementById('eventLocation').textContent = eventData.location || 'Location not specified';
    
    // Update event features
    document.getElementById('photosAllowed').textContent = eventData.allow_photos ? 'Photos allowed' : 'Photos not allowed';
    document.getElementById('videosAllowed').textContent = eventData.allow_videos ? 'Videos allowed' : 'Videos not allowed';
    document.getElementById('wishesAllowed').textContent = eventData.allow_wishes ? 'Wishes allowed' : 'Wishes not allowed';
    
    // Update statistics
    document.getElementById('guestPostsCount').textContent = eventData.total_guest_posts || 0;
    document.getElementById('mediaFilesCount').textContent = eventData.total_media_files || 0;

    // Update like count
    document.getElementById('likeCount').textContent = eventData.like_count || 0;

    // Update like button state
    updateLikeButton(eventData.is_liked_by_user);

    // Show QR code if available
    if (eventData.qr_code) {
        document.getElementById('eventQRCode').src = eventData.qr_code;
        document.getElementById('qrCodeSection').style.display = 'block';
        
        // Also populate share section QR code
        const shareQRCode = document.getElementById('shareQRCode');
        shareQRCode.innerHTML = `<img src="${eventData.qr_code}" alt="Event QR Code" class="img-fluid" style="max-width: 200px;">`;
    }

    // Populate share link input
    if (eventData.share_link) {
        document.getElementById('shareLinkInput').value = eventData.share_link;
    } else {
        document.getElementById('shareLinkInput').value = window.location.href;
    }
    
    // Update event thumbnail
    if (eventData.event_thumbnail) {
        document.getElementById('eventThumbnailContainer').innerHTML = 
            `<img src="${eventData.event_thumbnail}" class="img-fluid rounded" alt="Event thumbnail" style="max-width: 300px;">`;
    }
    
    // Show/hide upload sections based on event settings
    document.getElementById('photoUploadSection').style.display = eventData.allow_photos ? 'block' : 'none';
    document.getElementById('videoUploadSection').style.display = eventData.allow_videos ? 'block' : 'none';
    
    console.log('Event info display completed');
}

// Setup file uploads
function setupFileUploads() {
    // Photo upload
    const photoArea = document.getElementById('photoUploadArea');
    const photoInput = document.getElementById('photoInput');
    
    photoArea.addEventListener('click', () => photoInput.click());
    photoArea.addEventListener('dragover', handleDragOver);
    photoArea.addEventListener('drop', handlePhotoDrop);
    photoInput.addEventListener('change', handlePhotoSelect);
    
    // Video upload
    const videoArea = document.getElementById('videoUploadArea');
    const videoInput = document.getElementById('videoInput');
    
    videoArea.addEventListener('click', () => videoInput.click());
    videoArea.addEventListener('dragover', handleDragOver);
    videoArea.addEventListener('drop', handleVideoDrop);
    videoInput.addEventListener('change', handleVideoSelect);
}

// Handle drag and drop
function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handlePhotoDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
    handlePhotoFiles(files);
}

function handleVideoDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('video/'));
    handleVideoFiles(files);
}

// Handle file selection
function handlePhotoSelect(e) {
    const files = Array.from(e.target.files);
    handlePhotoFiles(files);
}

function handleVideoSelect(e) {
    const files = Array.from(e.target.files);
    handleVideoFiles(files);
}

// Handle photo files
function handlePhotoFiles(files) {
    files.forEach(file => {
        if (file.size > 50 * 1024 * 1024) { // 50MB limit
            showError(`Photo ${file.name} is too large. Maximum size is 50MB.`);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const photo = {
                file: file,
                preview: e.target.result,
                id: Date.now() + Math.random()
            };
            selectedPhotos.push(photo);
            displayPhotoPreview(photo);
        };
        reader.readAsDataURL(file);
    });
}

// Handle video files
function handleVideoFiles(files) {
    files.forEach(file => {
        if (file.size > 100 * 1024 * 1024) { // 100MB limit
            showError(`Video ${file.name} is too large. Maximum size is 100MB.`);
            return;
        }
        
        const video = {
            file: file,
            id: Date.now() + Math.random()
        };
        selectedVideos.push(video);
        displayVideoPreview(video);
    });
}

// Display photo preview
function displayPhotoPreview(photo) {
    const container = document.getElementById('photoPreviewContainer');
    const previewDiv = document.createElement('div');
    previewDiv.className = 'd-inline-block me-3 mb-3 position-relative';
    previewDiv.innerHTML = `
        <img src="${photo.preview}" alt="Photo preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" 
                onclick="removePhoto(${photo.id})" style="transform: translate(50%, -50%);">
            <i class="bi bi-x"></i>
        </button>
    `;
    container.appendChild(previewDiv);
}

// Display video preview
function displayVideoPreview(video) {
    const container = document.getElementById('videoPreviewContainer');
    const previewDiv = document.createElement('div');
    previewDiv.className = 'd-inline-block me-3 mb-3 position-relative';
    previewDiv.innerHTML = `
        <div class="bg-dark text-white d-flex align-items-center justify-content-center" 
             style="width: 100px; height: 100px; border-radius: 8px;">
            <i class="bi bi-camera-video"></i>
        </div>
        <div class="text-center mt-1">
            <small class="text-muted">${video.file.name}</small>
        </div>
        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" 
                onclick="removeVideo(${video.id})" style="transform: translate(50%, -50%);">
            <i class="bi bi-x"></i>
        </button>
    `;
    container.appendChild(previewDiv);
}

// Remove photo
function removePhoto(photoId) {
    selectedPhotos = selectedPhotos.filter(p => p.id !== photoId);
    refreshPhotoPreviews();
}

// Remove video
function removeVideo(videoId) {
    selectedVideos = selectedVideos.filter(v => v.id !== videoId);
    refreshVideoPreviews();
}

// Refresh photo previews
function refreshPhotoPreviews() {
    const container = document.getElementById('photoPreviewContainer');
    container.innerHTML = '';
    selectedPhotos.forEach(photo => displayPhotoPreview(photo));
}

// Refresh video previews
function refreshVideoPreviews() {
    const container = document.getElementById('videoPreviewContainer');
    container.innerHTML = '';
    selectedVideos.forEach(video => displayVideoPreview(video));
}

// Setup form validation
function setupFormValidation() {
    const form = document.getElementById('contributionForm');
    form.addEventListener('submit', handleFormSubmit);
}

// Handle form submission
async function handleFormSubmit(e) {
    e.preventDefault();
    
    if (!eventData) {
        showError('Event data not loaded');
        return;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Submitting...';
    
    try {
        const formData = new FormData();
        formData.append('event', eventData.id);
        formData.append('guest_name', document.getElementById('guestName').value);
        formData.append('guest_phone', document.getElementById('guestPhone').value);
        formData.append('wish_text', document.getElementById('wishText').value);
        
        // Add photos
        selectedPhotos.forEach(photo => {
            formData.append('photos', photo.file);
        });
        
        // Add videos
        selectedVideos.forEach(video => {
            formData.append('videos', video.file);
        });
        
        const response = await fetch('/api/guest-post-create/', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showSuccess();
            resetForm();
        } else {
            const error = await response.json();
            showError('Error submitting contribution: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error submitting contribution:', error);
        showError('Error submitting contribution');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-send"></i> Submit Contribution';
    }
}

// Show success modal
function showSuccess() {
    const modal = new bootstrap.Modal(document.getElementById('successModal'));
    modal.show();
}

// Show error modal
function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    const modal = new bootstrap.Modal(document.getElementById('errorModal'));
    modal.show();
}

// Reset form
function resetForm() {
    document.getElementById('contributionForm').reset();
    selectedPhotos = [];
    selectedVideos = [];
    refreshPhotoPreviews();
    refreshVideoPreviews();
}

// Load gallery
async function loadGallery() {
    if (!eventData) {
        console.error('No event data available for gallery');
        return;
    }
    
    console.log('Loading gallery for event:', eventData.id);
    
    try {
        const response = await fetch(`/api/public-events/${eventData.id}/posts/`);
        console.log('Gallery API Response status:', response.status);
        
        if (response.ok) {
            const posts = await response.json();
            console.log('Gallery posts loaded:', posts);
            galleryItems = posts;
            displayGallery();
        } else {
            const errorData = await response.json();
            console.error('Gallery API Error:', errorData);
        }
    } catch (error) {
        console.error('Error loading gallery:', error);
    }
}

// Display gallery
function displayGallery() {
    const container = document.getElementById('galleryContainer');
    container.innerHTML = '';
    
    if (galleryItems.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center">
                <div class="card">
                    <div class="card-body">
                        <i class="bi bi-images text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">No Contributions Yet</h5>
                        <p class="text-muted">Be the first to share your memories!</p>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    galleryItems.forEach(post => {
        const galleryItem = createGalleryItem(post);
        container.appendChild(galleryItem);
    });
}

// Create gallery item
function createGalleryItem(post) {
    const col = document.createElement('div');
    col.className = 'col-lg-4 col-md-6';
    
    let mediaContent = '';
    if (post.media_files && post.media_files.length > 0) {
        const media = post.media_files[0];
        if (media.media_type === 'photo') {
            mediaContent = `<img src="${media.media_file}" class="card-img-top" alt="Photo" style="height: 200px; object-fit: cover;">`;
        } else {
            mediaContent = `
                <div class="card-img-top bg-dark text-white d-flex align-items-center justify-content-center" style="height: 200px;">
                    <i class="bi bi-camera-video" style="font-size: 3rem;"></i>
                </div>
            `;
        }
    }
    
    col.innerHTML = `
        <div class="card card-hover h-100">
            ${mediaContent}
            <div class="card-body">
                <h6 class="card-title">${post.guest_name}</h6>
                <p class="card-text">${post.wish_text}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">${new Date(post.created_at).toLocaleDateString()}</small>
                    <span class="badge bg-info">${post.total_media_files || 0} media</span>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

// Load more gallery items
function loadMoreGalleryItems() {
    // Implement pagination if needed
    currentGalleryPage++;
    // This could load more items from the API
}

// Share event
function shareEvent() {
    if (navigator.share) {
        navigator.share({
            title: eventData.title,
            text: eventData.description || 'Check out this event!',
            url: window.location.href
        });
    } else {
        copyEventLink();
    }
}

// Copy event link
function copyEventLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        showAlert('Event link copied to clipboard!', 'success');
    }).catch(() => {
        showAlert('Failed to copy link', 'danger');
    });
}

// Copy share link
function copyShareLink() {
    const shareLinkInput = document.getElementById('shareLinkInput');
    shareLinkInput.select();
    shareLinkInput.setSelectionRange(0, 99999); // For mobile devices
    
    navigator.clipboard.writeText(shareLinkInput.value).then(() => {
        showAlert('Share link copied to clipboard!', 'success');
    }).catch(() => {
        showAlert('Failed to copy share link', 'danger');
    });
}

// Utility functions
function scrollToContribute() {
    document.getElementById('contribute').scrollIntoView({ behavior: 'smooth' });
}

function scrollToGallery() {
    document.getElementById('gallery').scrollIntoView({ behavior: 'smooth' });
}

// Like functionality
async function toggleLike() {
    if (!eventData) return;
    
    try {
        const response = await fetch(`/api/public-events/${eventData.id}/like/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Update like count
            document.getElementById('likeCount').textContent = result.like_count;
            
            // Update button state
            updateLikeButton(result.is_liked);
            
            // Show success message
            showAlert(result.message, 'success');
        } else {
            const error = await response.json();
            showAlert(error.error || 'Failed to update like', 'danger');
        }
    } catch (error) {
        showAlert('Error updating like', 'danger');
        console.error('Error:', error);
    }
}

function updateLikeButton(isLiked) {
    const likeButton = document.getElementById('likeButton');
    const likeIcon = document.getElementById('likeIcon');
    
    if (isLiked) {
        likeButton.classList.remove('btn-outline-danger');
        likeButton.classList.add('btn-danger');
        likeIcon.classList.remove('bi-heart');
        likeIcon.classList.add('bi-heart-fill');
    } else {
        likeButton.classList.remove('btn-danger');
        likeButton.classList.add('btn-outline-danger');
        likeIcon.classList.remove('bi-heart-fill');
        likeIcon.classList.add('bi-heart');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>
{% endblock %} 
{% endblock %} 